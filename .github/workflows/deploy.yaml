name: Enterprise CI/CD to OpenShift

on:
  push:
    branches: [ "main" ]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

      - name: Build Docker image
        run: docker build -t docker.io/${{ secrets.DOCKERHUB_USERNAME }}/new-app:${{ github.sha }} .

      - name: Push Docker image
        run: docker push docker.io/${{ secrets.DOCKERHUB_USERNAME }}/new-app:${{ github.sha }}

      - name: Install oc & helm
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/oc/latest/linux/oc.tar.gz
          tar -xzf oc.tar.gz
          sudo mv oc /usr/local/bin/
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Login to OpenShift
        run: oc login ${{ secrets.OPENSHIFT_SERVER }} --token=${{ secrets.OPENSHIFT_TOKEN }}

      - name: Determine active color
        id: color
        run: |
          ACTIVE=$(oc get svc enterprise-app -o jsonpath='{.spec.selector.color}' 2>/dev/null || echo "blue")
          if [ "$ACTIVE" = "blue" ]; then echo "next=green" >> $GITHUB_OUTPUT; else echo "next=blue" >> $GITHUB_OUTPUT; fi

      - name: Helm Deploy (Blue/Green)
        run: |
          helm upgrade --install new-app ./helm-chart \
            --set image.repository=docker.io/${{ secrets.DOCKERHUB_USERNAME }}/new-app \
            --set image.tag=${{ github.sha }} \
            --set activeColor=${{ steps.color.outputs.next }}

      - name: Health Check Validation
        run: |
          sleep 20
          URL=$(oc get route enterprise-app -o jsonpath='{.spec.host}')
          curl -f http://$URL/health

      - name: Rollback on Failure
        if: failure()
        run: |
          helm rollback enterprise-app
